name: Test & Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  syntax-check:
    name: Syntax & Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install pylint flake8 black isort mypy
    
    - name: Python syntax check (py_compile)
      run: |
        echo "üîç Checking Python syntax..."
        python -m py_compile file_search_tool.py
        python -m py_compile gui_search_tool.py
        python -m py_compile report_generator.py
        python -m py_compile i18n.py
        python -m py_compile language_config.py
        python -m py_compile gui_main.py
        python -m py_compile cli_main.py
        python -m py_compile version.py
        python -m py_compile setup_msi.py
        python -m py_compile build_msi.py
        python -m py_compile performance_config.py
        python -m py_compile language_config.py
        echo "‚úÖ All Python files have valid syntax"
    
    - name: Flake8 linting
      run: |
        echo "üîç Running flake8 linting..."
        flake8 file_search_tool.py gui_search_tool.py report_generator.py i18n.py --max-line-length=120 --count || true
        echo "‚úÖ Flake8 check completed"
    
    - name: Pylint analysis
      run: |
        echo "üîç Running pylint analysis..."
        pylint file_search_tool.py gui_search_tool.py report_generator.py i18n.py language_config.py --fail-under=7.0 --max-line-length=120 || true
        echo "‚úÖ Pylint analysis completed"
    
    - name: Code format check (black)
      run: |
        echo "üîç Checking code formatting..."
        black --check file_search_tool.py gui_search_tool.py report_generator.py i18n.py || true
        echo "‚úÖ Format check completed"
    
    - name: Import sort check (isort)
      run: |
        echo "üîç Checking import sorting..."
        isort --check-only file_search_tool.py gui_search_tool.py report_generator.py || true
        echo "‚úÖ Import sort check completed"

  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist coverage
    
    - name: Run unit tests
      run: |
        pytest tests/test_file_search_tool.py -v --cov=file_search_tool --cov-report=xml
    
    - name: Run integration tests
      run: |
        pytest tests/test_integration.py -v
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  functional-tests:
    name: Functional Tests
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Test version management
      run: |
        echo "Testing version management..."
        python -c "from version import VERSION, AUTHOR, EMAIL; print(f'‚úÖ Version: {VERSION}'); print(f'‚úÖ Author: {AUTHOR}'); print(f'‚úÖ Email: {EMAIL}')"
    
    - name: Test CLI entry point
      run: |
        echo "Testing CLI entry point..."
        python cli_main.py --help > $null 2>&1 || python cli_main.py --version
        echo "‚úÖ CLI entry point working"
    
    - name: Test imports
      run: |
        echo "Testing all module imports..."
        python -c "from file_search_tool import FileSearchTool; print('‚úÖ FileSearchTool imported')"
        python -c "from report_generator import HTMLReportGenerator; print('‚úÖ HTMLReportGenerator imported')"
        python -c "from i18n import I18n; print('‚úÖ I18n imported')"
        python -c "from language_config import LanguageConfig; print('‚úÖ LanguageConfig imported')"
    
    - name: Test translation files
      run: |
        echo "Testing translation files..."
        python -c "
        import json
        with open('locales/en.json') as f:
            en = json.load(f)
        with open('locales/de.json') as f:
            de = json.load(f)
        print(f'‚úÖ English translations: {len(en)} keys')
        print(f'‚úÖ German translations: {len(de)} keys')
        en_keys = set(en.keys())
        de_keys = set(de.keys())
        if en_keys == de_keys:
            print('‚úÖ Translation keys match')
        else:
            print(f'‚ö†Ô∏è  Missing in DE: {en_keys - de_keys}')
            print(f'‚ö†Ô∏è  Missing in EN: {de_keys - en_keys}')
        "
    
    - name: Test file search functionality
      run: |
        echo "Testing file search functionality..."
        python -c "
        from file_search_tool import FileSearchTool
        tool = FileSearchTool()
        tool.add_search_term('test')
        tool.set_search_mode('any')
        print('‚úÖ FileSearchTool can be configured')
        print('‚úÖ Search terms can be added')
        print('‚úÖ Search mode can be set')
        "
    
    - name: Test report generation
      run: |
        echo "Testing report generation..."
        python -c "
        from report_generator import HTMLReportGenerator
        gen = HTMLReportGenerator(language='en')
        report = gen.generate({
            'search_term': 'test',
            'results': [],
            'statistics': {'files_searched': 0, 'matches_found': 0}
        })
        if report and len(report) > 100:
            print('‚úÖ HTML report generated successfully')
        else:
            print('‚ö†Ô∏è  Report generation issue')
        "
    
    - name: Test MSI build configuration
      run: |
        echo "Testing MSI build configuration..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        from setup_msi import setup
        print('‚úÖ setup_msi.py is valid')
        print('‚úÖ MSI configuration can be loaded')
        "

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Bandit security check
      run: |
        echo "üîç Running Bandit security scan..."
        bandit -r file_search_tool.py gui_search_tool.py report_generator.py i18n.py -f csv || true
        echo "‚úÖ Security scan completed"
    
    - name: Check for hardcoded secrets
      run: |
        echo "üîç Checking for hardcoded secrets..."
        if grep -r "password\|api_key\|secret\|token" *.py 2>/dev/null | grep -v "# \|test\|def \|\""; then
          echo "‚ö†Ô∏è  Potential hardcoded secrets found"
          exit 1
        else
          echo "‚úÖ No hardcoded secrets found"
        fi

  build-verification:
    name: Build Verification
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cx_Freeze
        pip install -r requirements.txt
    
    - name: Verify build configuration
      run: |
        echo "Verifying build configuration..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        from version import VERSION
        print(f'‚úÖ Build version: {VERSION}')
        "
    
    - name: Test MSI build (dry run)
      run: |
        echo "Testing build process..."
        python build_msi.py
        if (Test-Path "build") {
            Write-Host "‚úÖ Build directory created"
        } else {
            Write-Host "‚ö†Ô∏è  Build directory not created"
        }
      shell: pwsh
      continue-on-error: true

  final-status:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [syntax-check, unit-tests, functional-tests, security-scan, build-verification]
    if: always()
    
    steps:
    - name: Check all tests passed
      run: |
        echo "üéâ All quality checks completed!"
        echo "‚úÖ Syntax check: ${{ needs.syntax-check.result }}"
        echo "‚úÖ Unit tests: ${{ needs.unit-tests.result }}"
        echo "‚úÖ Functional tests: ${{ needs.functional-tests.result }}"
        echo "‚úÖ Security scan: ${{ needs.security-scan.result }}"
        echo "‚úÖ Build verification: ${{ needs.build-verification.result }}"
