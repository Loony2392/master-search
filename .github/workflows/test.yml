name: ðŸ§ª CI/CD - Test & Quality Assurance

on:
  push:
    branches: [ main, develop, feature/* ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_extended_tests:
        description: 'Run extended test suite'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  MINIMUM_COVERAGE: 75

jobs:
  pre-flight-checks:
    name: ðŸ” Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Detect changes
      id: changes
      uses: dorny/paths-filter@v2
      with:
        filters: |
          src:
            - 'src/**'
            - '*.py'
          tests:
            - 'tests/**'
            - 'test_*.py'
          config:
            - 'locales/**'
            - 'requirements*.txt'
            - 'version.py'
    
    - name: Set matrix for tests
      id: set-matrix
      run: |
        if [[ "${{ steps.changes.outputs.src }}" == "true" ]] || [[ "${{ github.event.inputs.run_extended_tests }}" == "true" ]]; then
          echo "matrix={\"os\": [\"ubuntu-latest\", \"windows-latest\", \"macos-latest\"], \"python-version\": [\"3.9\", \"3.10\", \"3.11\"]}" >> $GITHUB_OUTPUT
        else
          echo "matrix={\"os\": [\"ubuntu-latest\"], \"python-version\": [\"3.11\"]}" >> $GITHUB_OUTPUT
        fi

  code-quality:
    name: ðŸ“ Code Quality & Standards
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install pylint flake8 black isort mypy bandit safety
    
    - name: ðŸ” Python syntax validation
      run: |
        echo "::group::Checking Python syntax"
        find . -name "*.py" -not -path "./build/*" -not -path "./.github/*" | while read file; do
          echo "Checking: $file"
          python -m py_compile "$file"
        done
        echo "âœ… All Python files have valid syntax"
        echo "::endgroup::"
    
    - name: ðŸŽ¨ Code formatting check (Black)
      run: |
        echo "::group::Code formatting check"
        black --check --diff --color .
        echo "::endgroup::"
    
    - name: ðŸ“‹ Import sorting (isort)
      run: |
        echo "::group::Import sorting check"
        isort --check-only --diff --color .
        echo "::endgroup::"
    
    - name: ðŸ”¬ Flake8 linting
      run: |
        echo "::group::Flake8 linting"
        flake8 . --max-line-length=120 --extend-ignore=E203,W503 --statistics
        echo "::endgroup::"
    
    - name: ðŸ” Pylint analysis
      run: |
        echo "::group::Pylint analysis"
        find . -name "*.py" -not -path "./build/*" -not -path "./tests/*" | xargs pylint --fail-under=7.0 --rcfile=.pylintrc || true
        echo "::endgroup::"
    
    - name: ðŸ›¡ï¸ Security scan (Bandit)
      run: |
        echo "::group::Security scan"
        bandit -r . -x tests/,build/ -f json -o bandit-report.json || true
        bandit -r . -x tests/,build/ -f txt || true
        echo "::endgroup::"
    
    - name: ðŸ“¦ Dependency security check
      run: |
        echo "::group::Dependency security check"
        safety check --json --output safety-report.json || true
        safety check || true
        echo "::endgroup::"

  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ${{ matrix.os }}
    needs: pre-flight-checks
    strategy:
      matrix: ${{ fromJson(needs.pre-flight-checks.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist pytest-html coverage
    
    - name: ðŸ§ª Run unit tests
      run: |
        echo "::group::Unit Tests"
        pytest tests/ -v \
          --cov=src \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=${{ env.MINIMUM_COVERAGE }} \
          --html=pytest-report.html \
          --self-contained-html \
          --junitxml=pytest-junit.xml
        echo "::endgroup::"
    
    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          pytest-report.html
          pytest-junit.xml
          coverage.xml
          htmlcov/
    
    - name: ðŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == env.PYTHON_VERSION
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  integration-tests:
    name: ðŸ”— Integration Tests  
    runs-on: ${{ matrix.os }}
    needs: pre-flight-checks
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: ðŸŒ Test localization system
      run: |
        echo "::group::Localization Tests"
        python test_complete_translations.py
        echo "::endgroup::"
    
    - name: ðŸ”§ Test version management
      run: |
        echo "::group::Version Management"
        python -c "
        import sys; sys.path.insert(0, 'src' if os.path.exists('src') else '.')
        from version import VERSION, AUTHOR, EMAIL, COMPANY
        print(f'âœ… Version: {VERSION}')
        print(f'âœ… Author: {AUTHOR}') 
        print(f'âœ… Email: {EMAIL}')
        print(f'âœ… Company: {COMPANY}')
        assert VERSION.count('.') >= 2, 'Version format invalid'
        print('âœ… Version format valid')
        "
        echo "::endgroup::"
    
    - name: ðŸŽ¯ Test core functionality
      run: |
        echo "::group::Core Functionality Tests"
        python -c "
        import sys, os
        sys.path.insert(0, 'src' if os.path.exists('src') else '.')
        
        # Test file search tool
        from file_search_tool import FileSearchTool
        tool = FileSearchTool()
        tool.add_search_term('test')
        tool.set_search_mode('any')
        print('âœ… FileSearchTool working')
        
        # Test i18n system
        from i18n import I18n, tr, set_locale
        i18n = I18n()
        set_locale('en')
        result = tr('app_title')
        print(f'âœ… I18n working: {result}')
        
        # Test platform utilities
        if os.path.exists('src/platform_utils.py'):
            from platform_utils import PlatformUtils
            platform = PlatformUtils.get_platform()
            print(f'âœ… Platform detection: {platform}')
        
        # Test animation system
        if os.path.exists('src/loading_animations.py'):
            import loading_animations
            print('âœ… Animation system loaded')
        
        print('âœ… All core components working')
        "
        echo "::endgroup::"
    
    - name: ðŸŽ¨ Test GUI components (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "::group::GUI Tests (Headless)"
        # Install virtual display for GUI testing
        sudo apt-get update
        sudo apt-get install -y xvfb
        
        # Test GUI imports without display
        python -c "
        import sys, os
        sys.path.insert(0, 'src' if os.path.exists('src') else '.')
        
        # Test GUI imports (without actually starting GUI)
        import gui_search_tool
        print('âœ… GUI search tool imports')
        
        if os.path.exists('src/loading_animations.py'):
            import loading_animations
            print('âœ… Loading animations import')
        
        print('âœ… GUI components import successfully')
        "
        echo "::endgroup::"

  build-tests:
    name: ðŸ—ï¸ Build Verification
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          pip install cx_Freeze
        fi
      shell: bash
    
    - name: ðŸ”§ Test build configuration
      run: |
        echo "::group::Build Configuration"
        if [ -f "setup_msi.py" ]; then
          python -c "
          import sys
          sys.path.insert(0, '.')
          try:
              from setup_msi import setup
              print('âœ… MSI setup configuration valid')
          except ImportError as e:
              print(f'âš ï¸  MSI setup not available: {e}')
          "
        fi
        
        if [ -f "scripts/build_dmg.py" ]; then
          python -c "
          import sys
          sys.path.insert(0, 'scripts')
          try:
              import build_dmg
              print('âœ… DMG build configuration available')
          except ImportError as e:
              print(f'âš ï¸  DMG build not available: {e}')
          "
        fi
        echo "::endgroup::"
      shell: bash

  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.run_extended_tests == 'true' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-benchmark memory_profiler
    
    - name: âš¡ Performance benchmarks
      run: |
        echo "::group::Performance Tests"
        # Create test files for performance testing
        mkdir -p test_perf_data
        for i in {1..100}; do
          echo "test content line $i" > "test_perf_data/test_file_$i.txt"
        done
        
        # Run performance tests
        python -c "
        import sys, time, os
        sys.path.insert(0, 'src' if os.path.exists('src') else '.')
        from file_search_tool import FileSearchTool
        
        # Test search performance
        start_time = time.time()
        tool = FileSearchTool()
        tool.set_search_directory('./test_perf_data')
        tool.add_search_term('test')
        tool.set_search_mode('any')
        
        # Simulate search (without actual file operations)
        end_time = time.time()
        duration = end_time - start_time
        
        print(f'âœ… Search setup completed in {duration:.4f} seconds')
        assert duration < 1.0, f'Setup too slow: {duration}s'
        print('âœ… Performance within acceptable limits')
        "
        
        # Cleanup
        rm -rf test_perf_data
        echo "::endgroup::"

  compatibility-matrix:
    name: ðŸ”„ Compatibility Matrix
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.run_extended_tests == 'true'
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, windows-2019, windows-2022, macos-11, macos-12]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        exclude:
          - os: macos-11
            python-version: '3.8'
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Quick compatibility test
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-minimal.txt
        python -c "
        import sys, os
        sys.path.insert(0, 'src' if os.path.exists('src') else '.')
        from version import VERSION
        print(f'âœ… Compatible: Python {sys.version} on ${{ matrix.os }}')
        print(f'âœ… Version: {VERSION}')
        "

  quality-gate:
    name: ðŸš¦ Quality Gate
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, build-tests]
    if: always()
    
    steps:
    - name: ðŸ“Š Evaluate quality gate
      run: |
        echo "::group::Quality Gate Results"
        echo "ðŸ“ Code Quality: ${{ needs.code-quality.result }}"
        echo "ðŸ§ª Unit Tests: ${{ needs.unit-tests.result }}"
        echo "ðŸ”— Integration Tests: ${{ needs.integration-tests.result }}"
        echo "ðŸ—ï¸ Build Tests: ${{ needs.build-tests.result }}"
        
        # Determine overall result
        if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
           [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
           [[ "${{ needs.integration-tests.result }}" == "success" ]] && \
           [[ "${{ needs.build-tests.result }}" == "success" ]]; then
          echo "ðŸŽ‰ âœ… QUALITY GATE: PASSED"
          echo "quality_gate_status=passed" >> $GITHUB_ENV
        else
          echo "âŒ QUALITY GATE: FAILED"
          echo "quality_gate_status=failed" >> $GITHUB_ENV
          exit 1
        fi
        echo "::endgroup::"
    
    - name: ðŸŽ¯ Set status check
      if: always()
      run: |
        echo "Quality Gate Status: $quality_gate_status"
