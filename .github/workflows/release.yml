name: ğŸš€ Release & Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g., 2025.11.11)'
        required: true
        type: string
      release_type:
        description: 'Release Type'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Pre-release?'
        required: false
        default: false
        type: boolean
      generate_builds:
        description: 'Generate build artifacts?'
        required: false
        default: true
        type: boolean
      deploy_docs:
        description: 'Deploy documentation?'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  validate-release:
    name: ğŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
      is_prerelease: ${{ steps.validate.outputs.is_prerelease }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from tag or input
      id: validate
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
          # Extract version from git tag
          VERSION="${{ github.ref }}"
          VERSION=${VERSION#refs/tags/v}
          IS_PRERELEASE="false"
        else
          # Use workflow input
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        # Validate version format (YYYY.MM.DD or YYYY.MM.DD.PATCH)
        if [[ ! "$VERSION" =~ ^[0-9]{4}\.[0-9]{1,2}\.[0-9]{1,2}(\.[0-9]+)?$ ]]; then
          echo "âŒ Invalid version format: $VERSION"
          echo "Expected format: YYYY.MM.DD or YYYY.MM.DD.PATCH"
          exit 1
        fi
        
        # Check if tag already exists (only for manual releases)
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if git tag -l | grep -q "^v$VERSION$"; then
            echo "âŒ Tag v$VERSION already exists"
            exit 1
          fi
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        
        echo "âœ… Release validation passed"
        echo "ğŸ“¦ Version: $VERSION"
        echo "ğŸ·ï¸ Tag: v$VERSION"
        echo "ğŸš§ Pre-release: $IS_PRERELEASE"

  run-full-tests:
    name: ğŸ§ª Full Test Suite
    uses: ./.github/workflows/test.yml
    secrets: inherit
    with:
      run_extended_tests: true

  update-version:
    name: ğŸ“ Update Version & Changelog
    runs-on: ubuntu-latest
    needs: [validate-release, run-full-tests]
    if: github.event_name == 'workflow_dispatch'
    outputs:
      changelog_content: ${{ steps.changelog.outputs.content }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Update version.py
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        echo "Updating version.py to $VERSION"
        
        cat > version.py << EOF
        #!/usr/bin/env python3
        # -*- coding: utf-8 -*-
        """
        Master Search - Version Management
        Single source of truth for version information

        Author: Loony2392
        Email: b.kolb@loony-tech.de
        """

        # VERSION INFORMATION - Update only here!
        VERSION = "$VERSION"
        AUTHOR = "Loony2392"
        EMAIL = "b.kolb@loony-tech.de"
        COMPANY = "LOONY-TECH"
        YEAR = "$(date +%Y)"
        GITHUB = "https://github.com/Loony2392/master-search"

        # Build version string
        VERSION_STRING = f"Master Search v{VERSION}"
        FULL_VERSION = f"{VERSION_STRING} (c) {YEAR} {COMPANY}"
        EOF
        
        echo "âœ… Version updated to $VERSION"
    
    - name: Generate changelog entry
      id: changelog
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        DATE=$(date +"%d. %B %Y")
        
        # Extract commits since last release
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --pretty=format:"- %s (%h)")
        else
          COMMITS=$(git log --oneline --pretty=format:"- %s (%h)" | head -20)
        fi
        
        # Generate changelog content
        CHANGELOG_ENTRY=$(cat << EOF
        ## [$VERSION] - $DATE

        ### ğŸ†• New Features & Improvements
        $COMMITS

        ### ğŸ“¦ Build Information
        - **Release Type:** ${{ github.event.inputs.release_type }}
        - **Pre-release:** ${{ github.event.inputs.prerelease }}
        - **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Commit:** $(git rev-parse --short HEAD)

        ---

        EOF
        )
        
        # Save changelog content for later use
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_ENTRY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "âœ… Changelog prepared"
    
    - name: Commit version changes
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git add version.py
        git commit -m "ğŸ”– Release v${{ needs.validate-release.outputs.version }}

        - Update version to ${{ needs.validate-release.outputs.version }}
        - Release type: ${{ github.event.inputs.release_type }}
        - Pre-release: ${{ github.event.inputs.prerelease }}"
        
        git push origin main
        
        echo "âœ… Version changes committed and pushed"

  build-artifacts:
    name: ğŸ—ï¸ Build Release Artifacts
    runs-on: ${{ matrix.os }}
    needs: [validate-release, update-version]
    if: always() && needs.validate-release.result == 'success' && (github.event.inputs.generate_builds == 'true' || github.event_name == 'push')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: windows-exe
            build_type: "Windows MSI"
          - os: macos-latest  
            artifact_name: macos-dmg
            build_type: "macOS DMG"
          - os: ubuntu-latest
            artifact_name: linux-source
            build_type: "Linux Source"
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main  # Use updated version for manual releases
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build Windows MSI
      if: matrix.os == 'windows-latest'
      run: |
        pip install cx_Freeze
        python build_msi.py
        
        # Find and rename MSI file
        $msiFile = Get-ChildItem -Path "build" -Recurse -Filter "Master Search-*.msi" | Select-Object -First 1
        if ($msiFile) {
          $newName = "Master_Search_v${{ needs.validate-release.outputs.version }}_Windows.msi"
          $destPath = "release_builds"
          New-Item -ItemType Directory -Force -Path $destPath
          Copy-Item $msiFile.FullName "$destPath\$newName"
          Write-Host "âœ… Windows MSI created: $newName"
        } else {
          Write-Error "âŒ MSI file not found"
        }
      shell: pwsh
    
    - name: Build macOS DMG
      if: matrix.os == 'macos-latest'
      run: |
        # Install py2app for macOS builds
        pip install py2app
        
        # Create basic DMG (simplified for now)
        mkdir -p release_builds
        zip -r "release_builds/Master_Search_v${{ needs.validate-release.outputs.version }}_macOS.zip" . \
          -x "*.git*" "*/__pycache__/*" "*/build/*" "*/dist/*" "*.pyc" "*.pyo"
        
        echo "âœ… macOS package created"
    
    - name: Build Linux Source
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p release_builds
        
        # Create source distribution
        pip install build
        python -m build --sdist
        cp dist/*.tar.gz "release_builds/Master_Search_v${{ needs.validate-release.outputs.version }}_Source.tar.gz"
        
        # Create standalone zip
        zip -r "release_builds/Master_Search_v${{ needs.validate-release.outputs.version }}_Source.zip" . \
          -x "*.git*" "*/__pycache__/*" "*/build/*" "*/dist/*" "*.pyc" "*.pyo"
        
        echo "âœ… Linux source packages created"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: release_builds/
        retention-days: 30

  create-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-artifacts]
    if: always() && needs.validate-release.result == 'success'
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Download all artifacts
      if: needs.build-artifacts.result == 'success'
      uses: actions/download-artifact@v3
      with:
        path: ./release_artifacts
    
    - name: Create Git tag
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git tag -a "${{ needs.validate-release.outputs.tag_name }}" -m "Master Search ${{ needs.validate-release.outputs.version }}

        ğŸ¯ Release Highlights:
        - Professional file search tool
        - Complete German localization
        - Modern animation system
        - Cross-platform support (Windows/macOS/Linux)

        ğŸ“¦ Build Information:
        - Version: ${{ needs.validate-release.outputs.version }}
        - Release Type: ${{ github.event.inputs.release_type }}
        - Pre-release: ${{ github.event.inputs.prerelease }}
        - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ğŸš€ Ready for production use!"
        
        git push origin "${{ needs.validate-release.outputs.tag_name }}"
        
        echo "âœ… Git tag created and pushed"
    
    - name: Prepare release notes
      id: release_notes
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        
        cat > release_notes.md << 'EOF'
        # ğŸ‰ Master Search v${{ needs.validate-release.outputs.version }}

        ## ğŸ“‹ Ãœbersicht / Overview

        **Deutsch:**
        Professional file search tool mit vollstÃ¤ndiger deutscher Lokalisierung und modernen Animationen.

        **English:**
        Professional file search tool with complete German localization and modern animations.

        ## ğŸš€ Hauptfeatures / Key Features

        - âœ… **Complete German GUI** - 138+ UI elements translated / VollstÃ¤ndige deutsche BenutzeroberflÃ¤che
        - âœ… **Modern Animations** - Smooth 60 FPS loading effects / Moderne 60 FPS Ladeanimationen  
        - âœ… **Cross-Platform** - Native Windows, macOS, Linux support / PlattformÃ¼bergreifend
        - âœ… **Professional Reports** - HTML reports with statistics / Professionelle HTML-Reports
        - âœ… **High Performance** - Multi-threaded search engine / Hochleistungs-Suchmaschine

        ## ğŸ“¦ Downloads

        Choose your platform / WÃ¤hlen Sie Ihre Plattform:

        - **Windows**: `Master_Search_v${{ needs.validate-release.outputs.version }}_Windows.msi` (Installer)
        - **macOS**: `Master_Search_v${{ needs.validate-release.outputs.version }}_macOS.zip` (Native Package)
        - **Linux/Source**: `Master_Search_v${{ needs.validate-release.outputs.version }}_Source.tar.gz` (Python source)

        ## ğŸš€ Quick Start

        ### Windows
        ```bash
        # Download and run installer
        Master_Search_v${{ needs.validate-release.outputs.version }}_Windows.msi
        ```

        ### macOS  
        ```bash
        # Download and extract
        unzip Master_Search_v${{ needs.validate-release.outputs.version }}_macOS.zip
        cd master-search-*
        python gui_main.py
        ```

        ### Linux/Source
        ```bash
        # Extract and run
        tar -xzf Master_Search_v${{ needs.validate-release.outputs.version }}_Source.tar.gz
        cd master-search-*
        pip install -r requirements.txt
        python gui_main.py
        ```

        ## ğŸ“– Documentation / Dokumentation

        - **User Guide (English)**: [USER_GUIDE_EN.md](USER_GUIDE_EN.md)
        - **Benutzerhandbuch (Deutsch)**: [USER_GUIDE_DE.md](USER_GUIDE_DE.md)
        - **Guide d'utilisateur (FranÃ§ais)**: [USER_GUIDE_FR.md](USER_GUIDE_FR.md)

        ## ğŸ› Bug Reports / Fehlerberichte

        - **English**: [Report bugs on GitHub](https://github.com/Loony2392/master-search/issues)
        - **Deutsch**: [Fehler auf GitHub melden](https://github.com/Loony2392/master-search/issues)

        ---

        **Developed by / Entwickelt von:** Loony2392  
        **Contact / Kontakt:** b.kolb@loony-tech.de  
        **Company / Firma:** LOONY-TECH  

        Â© 2025 LOONY-TECH - All rights reserved / Alle Rechte vorbehalten
        EOF
        
        echo "âœ… Release notes prepared"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate-release.outputs.tag_name }}
        name: Master Search v${{ needs.validate-release.outputs.version }}
        body_path: release_notes.md
        prerelease: ${{ needs.validate-release.outputs.is_prerelease }}
        draft: false
        files: |
          release_artifacts/**/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-documentation:
    name: ğŸ“š Deploy Documentation
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: github.event.inputs.deploy_docs == 'true' || github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Build documentation
      run: |
        mkdir -p _site
        
        # Copy documentation files
        cp README.md _site/
        cp *.md _site/
        
        # Create index page
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="de">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Master Search v${{ needs.validate-release.outputs.version }} - Documentation</title>
            <style>
                body { 
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
                  margin: 40px; 
                  background: #f6f8fa;
                }
                .header { 
                  text-align: center; 
                  margin-bottom: 40px; 
                  padding: 20px;
                  background: white;
                  border-radius: 8px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .version { color: #666; }
                .links { 
                  display: grid; 
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
                  gap: 20px; 
                }
                .card { 
                  background: white;
                  border: 1px solid #ddd; 
                  padding: 20px; 
                  border-radius: 8px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .card h3 { margin-top: 0; color: #0366d6; }
                .card a { text-decoration: none; color: #0366d6; }
                .card a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ” Master Search</h1>
                <p class="version">Version ${{ needs.validate-release.outputs.version }}</p>
                <p>Professional File Search Tool with German Localization</p>
            </div>
            <div class="links">
                <div class="card">
                    <h3>ğŸ“– User Guides</h3>
                    <p><a href="USER_GUIDE_DE.md">ğŸ‡©ğŸ‡ª Deutsches Benutzerhandbuch</a></p>
                    <p><a href="USER_GUIDE_EN.md">ğŸ‡ºğŸ‡¸ English User Guide</a></p>
                    <p><a href="USER_GUIDE_FR.md">ğŸ‡«ğŸ‡· Guide d'utilisateur FranÃ§ais</a></p>
                </div>
                <div class="card">
                    <h3>ğŸš€ Release Information</h3>
                    <p><a href="CHANGELOG.md">ğŸ“‹ Changelog</a></p>
                    <p><a href="README.md">ğŸ“– README</a></p>
                    <p><a href="https://github.com/Loony2392/master-search/releases/latest">ğŸ“¦ Download Latest</a></p>
                </div>
                <div class="card">
                    <h3>ğŸ“Š Development</h3>
                    <p><a href="https://github.com/Loony2392/master-search">ğŸ’» GitHub Repository</a></p>
                    <p><a href="https://github.com/Loony2392/master-search/issues">ğŸ› Bug Reports</a></p>
                    <p><a href="https://github.com/Loony2392/master-search/discussions">ğŸ’¬ Discussions</a></p>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        echo "âœ… Documentation site built"
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: _site
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  notification:
    name: ğŸ“§ Release Notification
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: always() && needs.create-release.result == 'success'
    
    steps:
    - name: Send success notification
      run: |
        echo "ğŸ‰ RELEASE SUCCESSFUL! ğŸ‰"
        echo ""
        echo "âœ… Version: ${{ needs.validate-release.outputs.version }}"
        echo "âœ… Tag: ${{ needs.validate-release.outputs.tag_name }}" 
        echo "âœ… Pre-release: ${{ needs.validate-release.outputs.is_prerelease }}"
        echo "âœ… Release URL: https://github.com/Loony2392/master-search/releases/tag/${{ needs.validate-release.outputs.tag_name }}"
        echo ""
        echo "ğŸ¯ Master Search v${{ needs.validate-release.outputs.version }} is now available!"
        echo "ğŸŒ Download: https://github.com/Loony2392/master-search/releases/latest"
        echo "ğŸ“š Documentation: https://loony2392.github.io/master-search/"
        echo ""
        echo "ğŸš€ Ready for production use!"
