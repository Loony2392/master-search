name: ðŸ“¦ Upload Release Assets

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2025.11.19)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  upload-assets:
    runs-on: ubuntu-latest
    name: Upload DMG & MSI to Release

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Find and verify artifacts
        id: artifacts
        run: |
          echo "ðŸ” Searching for release artifacts..."

          # Find DMG
          DMG_FILE=$(find releases/macos -maxdepth 1 -name "*.dmg" -type f | sort -V | tail -1)
          if [ -z "$DMG_FILE" ]; then
            echo "âŒ No DMG file found in releases/macos/"
            exit 1
          fi
          echo "dmg_file=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Found DMG: $DMG_FILE"
          DMG_SIZE=$(du -h "$DMG_FILE" | cut -f1)
          echo "   Size: $DMG_SIZE"

          # Find MSI
          MSI_FILE=$(find releases/windows -maxdepth 1 -name "*.msi" -type f | sort -V | tail -1)
          if [ -z "$MSI_FILE" ]; then
            echo "âš ï¸  No MSI file found in releases/windows/ (optional)"
            MSI_FILE=""
          else
            echo "âœ… Found MSI: $MSI_FILE"
            MSI_SIZE=$(du -h "$MSI_FILE" | cut -f1)
            echo "   Size: $MSI_SIZE"
          fi
          echo "msi_file=$MSI_FILE" >> $GITHUB_OUTPUT

      - name: ðŸ” Calculate SHA256 Checksums
        id: checksums
        run: |
          echo "ðŸ” Calculating SHA256 hashes..."

          # DMG checksum
          if [ ! -z "${{ steps.artifacts.outputs.dmg_file }}" ] && [ -f "${{ steps.artifacts.outputs.dmg_file }}" ]; then
            DMG_HASH=$(sha256sum "${{ steps.artifacts.outputs.dmg_file }}" | cut -d' ' -f1)
            echo "dmg_hash=$DMG_HASH" >> $GITHUB_OUTPUT
            echo "âœ… DMG SHA256:"
            echo "   $DMG_HASH"
          fi

          # MSI checksum
          if [ ! -z "${{ steps.artifacts.outputs.msi_file }}" ] && [ -f "${{ steps.artifacts.outputs.msi_file }}" ]; then
            MSI_HASH=$(sha256sum "${{ steps.artifacts.outputs.msi_file }}" | cut -d' ' -f1)
            echo "msi_hash=$MSI_HASH" >> $GITHUB_OUTPUT
            echo "âœ… MSI SHA256:"
            echo "   $MSI_HASH"
          fi

      - name: ðŸ“ Create Release Notes with Checksums
        id: release-notes
        run: |
          cat > release_notes.md << 'EOF'
          # ðŸŽ‰ Master Search v${{ github.event.inputs.version }} - Release

          **Release Date:** $(date +"%d. %B %Y")

          ## ðŸ“¥ Installation

          ### macOS (Apple Silicon & Intel)
          - **Download:** `Master_Search_v${{ github.event.inputs.version }}.dmg`
          - Double-click to mount
          - Drag **Master Search.app** to **Applications** folder
          - Launch from Applications folder

          ### Windows 64-bit
          - **Download:** `Master_Search-${{ github.event.inputs.version }}-win64.msi`
          - Run installer as Administrator
          - Follow the setup wizard
          - Launch from Start Menu

          ## ðŸ“‹ Checksums for Verification

          Use these SHA256 checksums to verify download integrity:

          ### macOS DMG
          ```
          ${{ steps.checksums.outputs.dmg_hash }}  Master_Search_v${{ github.event.inputs.version }}.dmg
          ```

          ### Windows MSI
          ```
          ${{ steps.checksums.outputs.msi_hash }}  Master_Search-${{ github.event.inputs.version }}-win64.msi
          ```

          ## âœ… Verify Your Download

          ### macOS (Terminal)
          ```bash
          cd ~/Downloads
          shasum -a 256 Master_Search_v${{ github.event.inputs.version }}.dmg
          # Compare the output with the hash above
          ```

          ### Windows (PowerShell)
          ```powershell
          cd ~\Downloads
          (Get-FileHash Master_Search-${{ github.event.inputs.version }}-win64.msi).Hash
          # Compare with the hash above
          ```

          ### Linux (Terminal)
          ```bash
          cd ~/Downloads
          sha256sum Master_Search_v${{ github.event.inputs.version }}.dmg
          # Compare with the hash above
          ```

          ## ðŸ†• New Features in v${{ github.event.inputs.version }}

          âœ¨ **Major Improvements:**
          - âœ… Automatic OCR installation & setup
          - âœ… Category-based file filtering with statistics
          - âœ… Smart string truncation focused on search matches
          - âœ… Dynamic Release Notes from markdown files
          - âœ… Enhanced category tooltips (20-100+ file types per category)
          - âœ… Full multilingual support (German, English, French)
          - âœ… Professional HTML reports with category badges

          ## ðŸ“š Documentation

          - [User Guide - English](https://github.com/Loony2392/master-search/blob/main/docs/guides/USER_GUIDE_EN.md)
          - [Benutzerhandbuch - Deutsch](https://github.com/Loony2392/master-search/blob/main/docs/guides/USER_GUIDE_DE.md)
          - [Installation Guide](https://github.com/Loony2392/master-search/blob/main/docs/guides/MACOS_INSTALLATION_GUIDE.md)
          - [OCR Installation Guide](https://github.com/Loony2392/master-search/blob/main/docs/OCR_INSTALLATION.md)

          ## ðŸ› Support

          - **Report bugs:** [GitHub Issues](https://github.com/Loony2392/master-search/issues)
          - **Discussions:** [GitHub Discussions](https://github.com/Loony2392/master-search/discussions)
          - **Website:** [LOONY-TECH](https://www.loony-tech.de)

          ---

          **Copyright Â© 2025 LOONY-TECH**  
          Author: Loony2392  
          Email: info@loony-tech.de  
          GitHub: [Loony2392/master-search](https://github.com/Loony2392/master-search)

          **Status:** ðŸŸ¢ Production Ready
          EOF

          cat release_notes.md

      - name: ðŸš€ Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Master Search v${{ github.event.inputs.version }}
          body_path: release_notes.md
          files: |
            ${{ steps.artifacts.outputs.dmg_file }}
            ${{ steps.artifacts.outputs.msi_file }}
          draft: false
          prerelease: false
          token: ${{ secrets.GH_TOKEN }}

      - name: ðŸ“Š Summary
        run: |
          echo "âœ… Release v${{ github.event.inputs.version }} created successfully!"
          echo ""
          echo "ðŸ“¦ Uploaded Assets:"
          if [ ! -z "${{ steps.artifacts.outputs.dmg_file }}" ]; then
            SIZE=$(du -h "${{ steps.artifacts.outputs.dmg_file }}" | cut -f1)
            echo "   âœ… DMG: $(basename ${{ steps.artifacts.outputs.dmg_file }}) ($SIZE)"
          fi
          if [ ! -z "${{ steps.artifacts.outputs.msi_file }}" ]; then
            SIZE=$(du -h "${{ steps.artifacts.outputs.msi_file }}" | cut -f1)
            echo "   âœ… MSI: $(basename ${{ steps.artifacts.outputs.msi_file }}) ($SIZE)"
          fi
          echo ""
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
          echo ""
          echo "ðŸ“‹ Checksums:"
          echo "   DMG SHA256: ${{ steps.checksums.outputs.dmg_hash }}"
          if [ ! -z "${{ steps.checksums.outputs.msi_hash }}" ]; then
            echo "   MSI SHA256: ${{ steps.checksums.outputs.msi_hash }}"
          fi
